<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Reflect Master - 100ë ˆë²¨ ê³ ì •íŒ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --cell: 60px; --red: #FF3B30; --blue: #007AFF; }
        body { font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; margin: 0; padding: 20px; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-bottom: 15px; text-align: center; width: 100%; max-width: 500px; }
        table { border-collapse: collapse; background: #fff; border: 3px solid #333; margin: 20px auto; }
        td { width: var(--cell); height: var(--cell); border: 1px solid #ddd; position: relative; padding: 0; }
        .edge { background: #f1f3f5; font-weight: bold; text-align: center; font-size: 14px; color: #495057; border: 1px solid #adb5bd !important; }
        .corner { background: #dee2e6; border: 1px solid #adb5bd !important; }
        .light-source { background: #FFD43B !important; }
        .light-source::after { content: 'ğŸ’¡'; display: block; font-size: 22px; text-align: center; line-height: var(--cell); }
        .mirror-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .mirror-line { stroke-width: 6; stroke-linecap: butt; }
        #timer { font-size: 2.5rem; font-weight: bold; font-family: monospace; margin: 10px 0; color: #333; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        input, button, select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #333; color: white; cursor: pointer; font-weight: bold; border: none; }
        button:hover { background: #000; }
        .coord-label { position: absolute; font-size: 10px; color: #bbb; top: 2px; left: 3px; z-index: 5; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>
    <div class="panel">
        <h1 style="margin:0 0 10px 0;">Reflect Master</h1>
        <div class="controls">
            <input type="text" id="nick" value="í”Œë ˆì´ì–´" style="width:80px;">
            <input type="number" id="lv_num" value="1" min="1" max="100" style="width:60px;">
            <button onclick="loadFixedProblem()">ë¬¸ì œ ì‹œì‘</button>
        </div>
        <div id="timer">00:00.00</div>
    </div>

    <div id="grid-target"></div>

    <div class="panel">
        <input type="text" id="ans_input" placeholder="ì •ë‹µ ì…ë ¥ (ì˜ˆ: 6 20)" style="width:150px;">
        <button onclick="checkAns()" style="background:#007AFF;">ì œì¶œ</button>
        <div id="rank-list" style="margin-top:15px; text-align: left;"></div>
    </div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const rows = "ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜";
        const cols = "ABCDEFGHIJKLMN";
        
        // [ì—¬ê¸°ì— 100ê°œì˜ ì‹¤ì œ ë°ì´í„°ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤]
        // ì˜ˆì‹œë¡œ 1, 2ë²ˆ ë°ì´í„°ë¥¼ ë„£ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” ì´ íŒ¨í„´ìœ¼ë¡œ 100ë²ˆê¹Œì§€ ì±„ì›Œì§‘ë‹ˆë‹¤.
        const FIXED_DATA = {
            "1": { size: 5, start: 2, ans: [6, 20], mirrors: {"0,1": {type:'b', color:'red'}, "0,3": {type:'b', color:'blue'}, "2,3": {type:'f', color:'red'}, "2,1": {type:'b', color:'red'}} },
            "2": { size: 5, start: 14, ans: [2, 18], mirrors: {"2,1": {type:'b', color:'red'}, "2,3": {type:'f', color:'red'}, "4,3": {type:'b', color:'red'}, "4,1": {type:'f', color:'blue'}} }
            // ... 100ë²ˆê¹Œì§€ ë°ì´í„° í™•ì¥ ê°€ëŠ¥
        };

        // ë°ì´í„°ê°€ ì—†ëŠ” ë²ˆí˜¸ë¥¼ ìœ„í•´ ë³´ì¡° ìƒì„±ê¸° (ì´ˆê¸° 1íšŒë§Œ ì‘ë™)
        function getProblem(num) {
            if (FIXED_DATA[num]) return FIXED_DATA[num];
            // ë°ì´í„°ê°€ ì—†ëŠ” ë²ˆí˜¸ ì„ íƒ ì‹œ ê³ ì • ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ì¦‰ì‹œ ìƒì„± (ì„œë²„ ë¶€í•˜ ì—†ìŒ)
            const size = 5 + Math.floor((num-1)/20); 
            let s = num * 999;
            return generateInstant(size, s);
        }

        function generateInstant(size, s) {
            let mirrors = {};
            let cells = []; for(let r=0; r<size; r++) for(let c=0; c<size; c++) cells.push({r,c});
            cells.sort(() => Math.sin(s++) - 0.5);
            for(let i=0; i<Math.floor(size*size*0.4); i++) {
                mirrors[`${cells[i].r},${cells[i].c}`] = { type: Math.sin(s++) > 0 ? 'f' : 'b', color: Math.sin(s++) > 0.7 ? 'blue' : 'red' };
            }
            for(let t=1; t<=size*4; t++) {
                let res = solve(t, size, mirrors);
                if(res.hits >= 3 && !res.loop) return { size, start: t, mirrors, ans: res.ans };
            }
            return generateInstant(size, s + 1); // ì•ˆì „ì¥ì¹˜
        }

        function solve(start, s, mirrors) {
            let res = new Set(), visited = new Set();
            let p = getStartCoord(start, s);
            function trace(r, c, dr, dc) {
                while(r>=0 && r<s && c>=0 && c<s) {
                    let st = `${r},${c},${dr},${dc}`;
                    if(visited.has(st)) return {loop: true};
                    visited.add(st);
                    let m = mirrors[`${r},${c}`];
                    if(m) {
                        if(m.color === 'blue') trace(r+dr, c+dc, dr, dc);
                        if(m.type === 'f') { let t=dr; dr=-dc; dc=-t; } else { let t=dr; dr=dc; dc=t; }
                    }
                    r += dr; c += dc;
                }
                let e = getEdgeID(r, c, s); if(e && e !== start) res.add(e);
                return {loop: false};
            }
            let out = trace(p.r, p.c, p.dr, p.dc);
            return { ans: Array.from(res).sort((a,b)=>a-b), hits: visited.size, loop: out.loop };
        }

        function getStartCoord(n, s) {
            if(n<=s) return {r:0, c:n-1, dr:1, dc:0};
            if(n<=s*2) return {r:n-s-1, c:s-1, dr:0, dc:-1};
            if(n<=s*3) return {r:s-1, c:s-(n-s*2), dr:-1, dc:0};
            return {r:s-(n-s*3), c:0, dr:0, dc:1};
        }

        function getEdgeID(r, c, s) {
            if(r===-1 && c>=0 && c<s) return c+1;
            if(c===s && r>=0 && r<s) return s+r+1;
            if(r===s && c>=0 && c<s) return s*2+(s-c);
            if(c===-1 && r>=0 && r<s) return s*3+(s-r);
            return null;
        }

        let currentProb = null, timerIdx = null, startT = 0;

        function loadFixedProblem() {
            const num = document.getElementById('lv_num').value;
            currentProb = getProblem(num);
            drawGrid(currentProb.size);
            loadRanks(num);
            clearInterval(timerIdx);
            startT = Date.now();
            timerIdx = setInterval(updateT, 50);
            document.getElementById('ans_input').value = "";
        }

        function drawGrid(s) {
            let h = '<table>';
            for(let r=-1; r<=s; r++) {
                h += '<tr>';
                for(let c=-1; c<=s; c++) {
                    let e = getEdgeID(r, c, s);
                    if(r===-1||r===s||c===-1||c===s) {
                        if((r===-1||r===s)&&(c===-1||c===s)) h += '<td class="corner"></td>';
                        else h += `<td class="edge ${e===currentProb.start?'light-source':''}">${e||''}</td>`;
                    } else {
                        let m = currentProb.mirrors[`${r},${c}`];
                        let label = `<span class="coord-label">${rows[r]}${cols[c]}</span>`;
                        let mirrorHtml = '';
                        if(m) {
                            const color = m.color === 'red' ? 'var(--red)' : 'var(--blue)';
                            const x1 = m.type === 'f' ? '100' : '0';
                            const y1 = '0';
                            const x2 = m.type === 'f' ? '0' : '100';
                            const y2 = '100';
                            mirrorHtml = `<svg class="mirror-svg" viewBox="0 0 100 100" preserveAspectRatio="none"><line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="mirror-line" stroke="${color}" /></svg>`;
                        }
                        h += `<td>${label}${mirrorHtml}</td>`;
                    }
                }
                h += '</tr>';
            }
            document.getElementById('grid-target').innerHTML = h + '</table>';
        }

        function updateT() {
            let d = Date.now()-startT;
            let ms = String(d%1000).padStart(3,'0').slice(0,2);
            let s = String(Math.floor(d/1000)%60).padStart(2,'0');
            let m = String(Math.floor(d/60000)).padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}.${ms}`;
        }

        function checkAns() {
            let u = document.getElementById('ans_input').value.trim().split(/\s+/).map(Number).sort((a,b)=>a-b).join();
            let a = currentProb.ans.join();
            if(u === a) { clearInterval(timerIdx); alert("ì •ë‹µ!"); save(); }
            else alert("ì˜¤ë‹µ!");
        }

        function save() {
            const num = document.getElementById('lv_num').value;
            db.ref(`ranks/p${num}`).push({ n: document.getElementById('nick').value, t: document.getElementById('timer').innerText, ts: firebase.database.ServerValue.TIMESTAMP });
        }

        function loadRanks(num) {
            db.ref(`ranks/p${num}`).orderByChild('t').limitToFirst(5).on('value', snap => {
                let h = "<strong>ğŸ† TOP 5 ê¸°ë¡</strong>";
                snap.forEach(c => { h += `<div class="rank-item"><span>${c.val().n}</span><b>${c.val().t}</b></div>`; });
                document.getElementById('rank-list').innerHTML = h;
            });
        }
    </script>
</body>
</html>