<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Reflect Master - ì •ì‹ 100ë‹¨ê³„ ë²„ì „</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --cell: 60px; --red: #FF3B30; --blue: #007AFF; }
        body { font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; margin: 0; padding: 20px; }
        .panel { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-bottom: 15px; text-align: center; width: 100%; max-width: 550px; }
        table { border-collapse: collapse; background: #fff; border: 3px solid #333; margin: 20px auto; }
        td { width: var(--cell); height: var(--cell); border: 1px solid #ddd; position: relative; padding: 0; }
        .edge { background: #f1f3f5; font-weight: bold; text-align: center; font-size: 14px; color: #495057; border: 1px solid #adb5bd !important; }
        .corner { background: #dee2e6; border: 1px solid #adb5bd !important; }
        .light-source { background: #FFD43B !important; }
        .light-source::after { content: 'ğŸ’¡'; display: block; font-size: 22px; text-align: center; line-height: var(--cell); }
        .mirror-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .mirror-line { stroke-width: 6; stroke-linecap: butt; } /* ëì  ë”± ë§ê²Œ ì„¤ì • */
        #timer { font-size: 2.5rem; font-weight: bold; font-family: monospace; margin: 10px 0; color: #333; height: 1.2em; }
        button { background: #333; color: white; border: none; padding: 12px 24px; cursor: pointer; font-weight: bold; border-radius: 8px; transition: 0.2s; }
        button:hover { background: #000; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; }
        .coord-label { position: absolute; font-size: 10px; color: #bbb; top: 2px; left: 3px; z-index: 5; }
    </style>
</head>
<body>
    <div class="panel">
        <h1 style="margin:0 0 10px 0;">Reflect Master</h1>
        <div>
            <input type="text" id="nick" value="í”Œë ˆì´ì–´" style="width:80px; padding:10px; border-radius:6px; border:1px solid #ddd;">
            <select id="lv" style="padding:10px; border-radius:6px; border:1px solid #ddd;">
                <option value="5">1ë‹¨ê³„ (5x5)</option>
                <option value="6">2ë‹¨ê³„ (6x6)</option>
                <option value="7">3ë‹¨ê³„ (7x7)</option>
                <option value="8">4ë‹¨ê³„ (8x8)</option>
                <option value="9">5ë‹¨ê³„ (9x9)</option>
            </select>
            <input type="number" id="p_num" value="1" min="1" max="20" style="width:50px; padding:10px; border-radius:6px; border:1px solid #ddd;">
            <button onclick="loadProblem()">ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div id="timer">00:00.00</div>
    </div>
    <div id="grid-target"></div>
    <div class="panel" style="margin-top:15px">
        <input type="text" id="ans_input" placeholder="ì •ë‹µ (ì˜ˆ: 6 20)" style="width:180px; padding:12px; font-size:16px; border:2px solid #333; border-radius:8px;">
        <button onclick="checkAns()" style="background:#007AFF;">ì œì¶œ</button>
        <div id="rank-list" style="margin-top:15px; text-align: left;"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const rows = "ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜";
        const cols = "ABCDEFGHIJKLMN";
        const problemDatabase = {}; // 100ê°œì˜ ê³ ì • ë¬¸ì œ ì €ì¥ì†Œ

        // [í•µì‹¬] ê³ ì •ëœ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ 100ê°œì˜ ìœ íš¨í•œ ë¬¸ì œë¥¼ ë¯¸ë¦¬ í™•ì •
        function buildDatabase() {
            for(let lv=5; lv<=9; lv++) {
                for(let num=1; num<=20; num++) {
                    let seed = (lv * 123) + num; // ì ˆëŒ€ ë³€í•˜ì§€ ì•ŠëŠ” ì‹œë“œ
                    problemDatabase[`${lv}_${num}`] = generateValidOne(lv, seed);
                }
            }
        }

        function generateValidOne(size, seed) {
            let s = seed;
            while(true) {
                let mirrors = {};
                let cells = []; for(let r=0; r<size; r++) for(let c=0; c<size; c++) cells.push({r,c});
                cells.sort(() => Math.sin(s++) - 0.5);
                let blueC = 0;
                for(let i=0; i<Math.floor(size*size*0.5); i++) {
                    let isB = (blueC < 10 && Math.sin(s++) > 0.6);
                    if(isB) blueC++;
                    mirrors[`${cells[i].r},${cells[i].c}`] = {
                        type: Math.sin(s++) > 0 ? 'f' : 'b',
                        color: isB ? 'blue' : 'red'
                    };
                }
                for(let t=1; t<=size*4; t++) {
                    let res = solveEngine(t, size, mirrors);
                    if(res.hits >= 3 && !res.loop && res.ans.length > 0) {
                        return { start: t, mirrors, ans: res.ans, size };
                    }
                }
                s += 10; // ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì‹œë“œ ë³€ê²½ í›„ ì¬íƒìƒ‰
            }
        }

        function solveEngine(start, s, mirrors) {
            let res = new Set(), hits = 0, isLoop = false, visited = new Set();
            let p = getStartCoord(start, s);
            function trace(r, c, dr, dc) {
                let safety = 0;
                while(r>=0 && r<s && c>=0 && c<s && safety < 100) {
                    let st = `${r},${c},${dr},${dc}`;
                    if(visited.has(st)) { isLoop = true; return; }
                    visited.add(st);
                    let m = mirrors[`${r},${c}`];
                    if(m) {
                        hits++;
                        if(m.color === 'blue') trace(r+dr, c+dc, dr, dc);
                        if(m.type === 'f') { let t=dr; dr=-dc; dc=-t; } else { let t=dr; dr=dc; dc=t; }
                    }
                    r += dr; c += dc; safety++;
                }
                let e = getEdgeID(r, c, s); if(e && e !== start) res.add(e);
            }
            trace(p.r, p.c, p.dr, p.dc);
            return { ans: Array.from(res).sort((a,b)=>a-b), hits, loop: isLoop };
        }

        function getStartCoord(n, s) {
            if(n<=s) return {r:0, c:n-1, dr:1, dc:0};
            if(n<=s*2) return {r:n-s-1, c:s-1, dr:0, dc:-1};
            if(n<=s*3) return {r:s-1, c:s-(n-s*2), dr:-1, dc:0};
            return {r:s-(n-s*3), c:0, dr:0, dc:1};
        }

        function getEdgeID(r, c, s) {
            if(r===-1 && c>=0 && c<s) return c+1;
            if(c===s && r>=0 && r<s) return s+r+1;
            if(r===s && c>=0 && c<s) return s*2+(s-c);
            if(c===-1 && r>=0 && r<s) return s*3+(s-r);
            return null;
        }

        let currentProb = null, timerIdx = null, startT = 0;
        buildDatabase(); // í˜ì´ì§€ ë¡œë“œ ì‹œ 100ë¬¸ì œ ì¦‰ì‹œ í™•ì •

        function loadProblem() {
            const lv = document.getElementById('lv').value;
            const num = document.getElementById('p_num').value;
            currentProb = problemDatabase[`${lv}_${num}`];

            drawGrid(currentProb.size);
            loadRanks(lv, num);
            
            clearInterval(timerIdx);
            startT = Date.now();
            timerIdx = setInterval(updateT, 50);
            document.getElementById('ans_input').value = "";
        }

        function drawGrid(s) {
            let h = '<table>';
            for(let r=-1; r<=s; r++) {
                h += '<tr>';
                for(let c=-1; c<=s; c++) {
                    let e = getEdgeID(r, c, s);
                    if(r===-1||r===s||c===-1||c===s) {
                        if((r===-1||r===s)&&(c===-1||c===s)) h += '<td class="corner"></td>';
                        else h += `<td class="edge ${e===currentProb.start?'light-source':''}">${e||''}</td>`;
                    } else {
                        let m = currentProb.mirrors[`${r},${c}`];
                        let label = `<span class="coord-label">${rows[r]}${cols[c]}</span>`;
                        let mirrorHtml = '';
                        if(m) {
                            const color = m.color === 'red' ? 'var(--red)' : 'var(--blue)';
                            const x1 = m.type === 'f' ? '100' : '0';
                            const y1 = '0';
                            const x2 = m.type === 'f' ? '0' : '100';
                            const y2 = '100';
                            mirrorHtml = `<svg class="mirror-svg" viewBox="0 0 100 100" preserveAspectRatio="none"><line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="mirror-line" stroke="${color}" /></svg>`;
                        }
                        h += `<td>${label}${mirrorHtml}</td>`;
                    }
                }
                h += '</tr>';
            }
            document.getElementById('grid-target').innerHTML = h + '</table>';
        }

        function updateT() {
            let d = Date.now()-startT;
            let ms = String(d%1000).padStart(3,'0').slice(0,2);
            let s = String(Math.floor(d/1000)%60).padStart(2,'0');
            let m = String(Math.floor(d/60000)).padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}.${ms}`;
        }

        function checkAns() {
            let u = document.getElementById('ans_input').value.trim().split(/\s+/).map(Number).sort((a,b)=>a-b).join();
            let a = currentProb.ans.join();
            if(u === a) {
                clearInterval(timerIdx);
                alert("ì •ë‹µì…ë‹ˆë‹¤!");
                save();
            } else alert("ì˜¤ë‹µì…ë‹ˆë‹¤!");
        }

        function save() {
            const lv = document.getElementById('lv').value, num = document.getElementById('p_num').value;
            db.ref(`ranks/lv${lv}/p${num}`).push({ n: document.getElementById('nick').value, t: document.getElementById('timer').innerText, ts: firebase.database.ServerValue.TIMESTAMP });
        }

        function loadRanks(lv, num) {
            db.ref(`ranks/lv${lv}/p${num}`).orderByChild('t').limitToFirst(5).on('value', snap => {
                let h = "<strong>ğŸ† TOP 5 ê¸°ë¡</strong>";
                snap.forEach(c => { h += `<div class="rank-item"><span>${c.val().n}</span><b>${c.val().t}</b></div>`; });
                document.getElementById('rank-list').innerHTML = h;
            });
        }
    </script>
</body>
</html>