<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Reflect Master - Ï†ïÏãù Î≤ÑÏ†Ñ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --cell: 55px; --red: #FF3B30; --blue: #007AFF; --thick: 4px; }
        body { font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; margin: 0; padding: 20px; }
        .panel { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-bottom: 15px; text-align: center; width: 100%; max-width: 550px; }
        table { border-collapse: collapse; background: #fff; border: 3px solid #333; margin: 20px auto; }
        td { width: var(--cell); height: var(--cell); border: 1px solid #ddd; position: relative; padding: 0; overflow: hidden; }
        .edge { background: #f1f3f5; font-weight: bold; text-align: center; font-size: 14px; color: #495057; }
        .corner { background: #dee2e6; }
        .light-source { background: #FFD43B !important; }
        .light-source::after { content: 'üí°'; display: block; font-size: 20px; text-align: center; line-height: var(--cell); }
        
        /* Í±∞Ïö∏ Í∑∏ÎûòÌîΩ: Ïπ∏ Ï†ÑÏ≤¥Î•º Í∞ÄÎ°úÏßÄÎ•¥Îäî ÍΩâ Ï∞¨ ÎåÄÍ∞ÅÏÑ† */
        .mirror { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .mirror::before { content: ""; position: absolute; width: 142%; height: var(--thick); border-radius: 2px; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
        
        /* fÌÉÄÏûÖ (/): Ïö∞ÏÉÅÌñ• ÎåÄÍ∞ÅÏÑ† (Ï¢åÌïòÎã® -> Ïö∞ÏÉÅÎã®) */
        .mirror.f::before { transform: rotate(-45deg); background-color: var(--c); }
        /* bÌÉÄÏûÖ (\): Ï¢åÏÉÅÌñ• ÎåÄÍ∞ÅÏÑ† (Ï¢åÏÉÅÎã® -> Ïö∞ÌïòÎã®) */
        .mirror.b::before { transform: rotate(45deg); background-color: var(--c); }
        
        .red { --c: var(--red); } .blue { --c: var(--blue); }
        
        #timer { font-size: 2.5rem; font-weight: bold; font-family: monospace; margin: 10px 0; color: #333; }
        button { background: #333; color: white; border: none; padding: 12px 24px; cursor: pointer; font-weight: bold; border-radius: 8px; transition: 0.2s; }
        button:hover { background: #000; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; }
        .coord-label { position: absolute; font-size: 9px; color: #ccc; top: 2px; left: 2px; pointer-events: none; z-index: 5; }
    </style>
</head>
<body>
    <div class="panel">
        <h1 style="margin:0 0 10px 0;">Reflect Master</h1>
        <div>
            <input type="text" id="nick" placeholder="ÎãâÎÑ§ÏûÑ" value="ÌîåÎ†àÏù¥Ïñ¥" style="width:80px; padding:10px; border-radius:6px; border:1px solid #ddd;">
            <select id="lv" style="padding:10px; border-radius:6px; border:1px solid #ddd;">
                <option value="5">1Îã®Í≥Ñ (Í∞Ä-Îßà)</option>
                <option value="6">2Îã®Í≥Ñ (Í∞Ä-Î∞î)</option>
                <option value="7">3Îã®Í≥Ñ (Í∞Ä-ÏÇ¨)</option>
                <option value="8">4Îã®Í≥Ñ (Í∞Ä-ÏïÑ)</option>
                <option value="9">5Îã®Í≥Ñ (Í∞Ä-Ïûê)</option>
            </select>
            <input type="number" id="p_num" value="1" min="1" max="20" style="width:50px; padding:10px; border-radius:6px; border:1px solid #ddd;">
            <button onclick="startGame()">Î¨∏Ï†ú ÏÉùÏÑ±</button>
        </div>
        <div id="timer">00:00.00</div>
    </div>
    <div id="grid-target"></div>
    <div class="panel" style="margin-top:15px">
        <input type="text" id="ans_input" placeholder="Ï†ïÎãµ (Ïòà: 6 20)" style="width:180px; padding:12px; font-size:16px; border:2px solid #333; border-radius:8px;">
        <button onclick="checkAns()" style="background:#007AFF;">Ï†úÏ∂ú</button>
        <div id="rank-list" style="margin-top:15px; text-align: left;"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let prob = { size: 0, mirrors: {}, ans: [], start: 0 };
        let timer, startT;
        const rows = "Í∞ÄÎÇòÎã§ÎùºÎßàÎ∞îÏÇ¨ÏïÑÏûêÏ∞®Ïπ¥ÌÉÄÌååÌïò";
        const cols = "ABCDEFGHIJKLMN";

        function seededRand(s) { var x = Math.sin(s) * 10000; return x - Math.floor(x); }

        function startGame() {
            const size = parseInt(document.getElementById('lv').value);
            const num = parseInt(document.getElementById('p_num').value);
            let s = (size * 77) + num;

            let valid = false;
            while(!valid) {
                genProb(size, s++);
                if(prob.ans.length > 0) valid = true;
            }

            drawGrid(size);
            loadRanks(size, num);
            clearInterval(timer);
            startT = Date.now();
            timer = setInterval(updateT, 50);
            document.getElementById('ans_input').value = "";
        }

        function genProb(size, seed) {
            let s = seed; prob.mirrors = {}; prob.size = size;
            const mCount = Math.floor(size * size * 0.45);
            let cells = []; for(let r=0; r<size; r++) for(let c=0; c<size; c++) cells.push({r,c});
            cells.sort(() => seededRand(s++) - 0.5);

            let blueC = 0;
            for(let i=0; i<mCount; i++) {
                let isB = (blueC < 10 && seededRand(s++) > 0.7);
                if(isB) blueC++;
                prob.mirrors[`${cells[i].r},${cells[i].c}`] = {
                    type: seededRand(s++) > 0.5 ? 'f' : 'b',
                    color: isB ? 'blue' : 'red'
                };
            }

            let found = false, attempts = 0;
            while(!found && attempts < 100) {
                let testStart = Math.floor(seededRand(s++) * (size * 4)) + 1;
                let res = solve(testStart, size, prob.mirrors);
                if(res.hits >= 3 && !res.loop && res.ans.length > 0) {
                    prob.start = testStart; prob.ans = res.ans; found = true;
                }
                attempts++;
            }
            if(!found) prob.ans = [];
        }

        function solve(start, s, mirrors) {
            let res = new Set(), hits = 0, isLoop = false, visited = new Set();
            let p = getStart(start, s);
            function trace(r, c, dr, dc) {
                while(r>=0 && r<s && c>=0 && c<s) {
                    let st = `${r},${c},${dr},${dc}`;
                    if(visited.has(st)) { isLoop = true; return; }
                    visited.add(st);
                    let m = mirrors[`${r},${c}`];
                    if(m) {
                        hits++;
                        if(m.color === 'blue') trace(r+dr, c+dc, dr, dc);
                        if(m.type === 'f') { let t=dr; dr=-dc; dc=-t; }
                        else { let t=dr; dr=dc; dc=t; }
                    }
                    r += dr; c += dc;
                }
                let e = getEdge(r, c, s); if(e && e !== start) res.add(e);
            }
            trace(p.r, p.c, p.dr, p.dc);
            return { ans: Array.from(res).sort((a,b)=>a-b), hits, loop: isLoop };
        }

        function getStart(n, s) {
            if(n<=s) return {r:0, c:n-1, dr:1, dc:0};
            if(n<=s*2) return {r:n-s-1, c:s-1