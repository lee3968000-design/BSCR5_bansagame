<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Reflect Master - ê¸°ë¡ ë³´ë“œ ë²„ì „</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --cell: 60px; --red: #FF3B30; --blue: #007AFF; }
        body { font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; margin: 0; padding: 20px; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-bottom: 15px; text-align: center; width: 100%; max-width: 500px; }
        table { border-collapse: collapse; background: #fff; border: 3px solid #333; margin: 20px auto; }
        td { width: var(--cell); height: var(--cell); border: 1px solid #ddd; position: relative; padding: 0; }
        .edge { background: #f1f3f5; font-weight: bold; text-align: center; font-size: 14px; color: #495057; border: 1px solid #adb5bd !important; }
        .corner { background: #dee2e6; border: 1px solid #adb5bd !important; }
        .light-source { background: #FFD43B !important; }
        .light-source::after { content: 'ğŸ’¡'; display: block; font-size: 22px; text-align: center; line-height: var(--cell); }
        .mirror-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .mirror-line { stroke-width: 6; stroke-linecap: butt; }
        #timer { font-size: 2.5rem; font-weight: bold; font-family: monospace; margin: 10px 0; color: #333; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        input, button { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #333; color: white; cursor: pointer; font-weight: bold; border: none; }
        button:hover { background: #000; }
        .coord-label { position: absolute; font-size: 10px; color: #bbb; top: 2px; left: 3px; z-index: 5; }
        
        /* ë­í‚¹ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .rank-container { margin-top:15px; text-align: left; max-height: 300px; overflow-y: auto; }
        .rank-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; line-height: 1.5; }
        .rank-item b { color: #007AFF; }
        .rank-item i { color: #888; font-style: normal; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="panel">
        <h1 style="margin:0 0 10px 0;">Reflect Master</h1>
        <div class="controls">
            <input type="text" id="nick" value="í”Œë ˆì´ì–´" style="width:80px;">
            <input type="number" id="lv_num" value="1" min="1" max="100" style="width:60px;">
            <button onclick="loadProblem()">ë¬¸ì œ ì‹œì‘</button>
        </div>
        <div id="timer">00:00.00</div>
    </div>

    <div id="grid-target"></div>

    <div class="panel">
        <input type="text" id="ans_input" placeholder="ë‹µ ì…ë ¥ (ì˜ˆ: 3 5 7)" style="width:200px;">
        <button onclick="submitRecord()" style="background:#007AFF;">ì œì¶œ ë° ê¸°ë¡</button>
        <div class="rank-container" id="rank-list">
            <p style="color:#999; text-align:center;">ë¬¸ì œë¥¼ ì‹œì‘í•˜ë©´ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const rows = "ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜";
        const cols = "ABCDEFGHIJKLMN";
        let currentProb = null, timerIdx = null, startT = 0;

        function getProblem(num) {
            const size = 5 + Math.floor((num-1)/20); 
            let s = num * 999;
            return generateProblem(size, s);
        }

        function generateProblem(size, s) {
            let mirrors = {};
            let cells = []; for(let r=0; r<size; r++) for(let c=0; c<size; c++) cells.push({r,c});
            cells.sort(() => Math.sin(s++) - 0.5);
            for(let i=0; i<Math.floor(size*size*0.45); i++) {
                mirrors[`${cells[i].r},${cells[i].c}`] = { 
                    type: Math.sin(s++) > 0 ? 'f' : 'b', 
                    color: Math.sin(s++) > 0.7 ? 'blue' : 'red' 
                };
            }
            // ì ì–´ë„ 3ë²ˆ êµ´ì ˆë˜ëŠ” ì‹œì‘ì  ì°¾ê¸° (ì±„ì ì€ ì•ˆ í•˜ì§€ë§Œ ìµœì†Œ ë‚œì´ë„ ë³´ì¥ìš©)
            for(let t=1; t<=size*4; t++) {
                if (validate(t, size, mirrors)) return { size, start: t, mirrors };
            }
            return generateProblem(size, s + 1);
        }

        function validate(start, s, mirrors) {
            let hits = 0, visited = new Set();
            let r, c, dr, dc;
            // ì‹œì‘ ì¢Œí‘œ ì„¤ì •
            if(start<=s) {r=0; c=start-1; dr=1; dc=0;}
            else if(start<=s*2) {r=start-s-1; c=s-1; dr:0; dc=-1;}
            else if(start<=s*3) {r=s-1; c=s-(start-s*2); dr:-1; dc:0;}
            else {r=s-(start-s*3); c:0; dr:0; dc:1;}

            let step = 0;
            while(r>=0 && r<s && c>=0 && c<s && step < 100) {
                if(mirrors[`${r},${c}`]) hits++;
                r += 1; // ë‹¨ìˆœ ê²½ë¡œ ì¡´ì¬ í™•ì¸
                step++;
            }
            return hits >= 2;
        }

        function loadProblem() {
            const num = document.getElementById('lv_num').value;
            currentProb = getProblem(num);
            drawGrid(currentProb.size);
            loadRecords(num);
            clearInterval(timerIdx);
            startT = Date.now();
            timerIdx = setInterval(updateTimer, 50);
            document.getElementById('ans_input').value = "";
        }

        function drawGrid(s) {
            let h = '<table>';
            for(let r=-1; r<=s; r++) {
                h += '<tr>';
                for(let c=-1; c<=s; c++) {
                    let e = getEdgeID(r, c, s);
                    if(r===-1||r===s||c===-1||c===s) {
                        if((r===-1||r===s)&&(c===-1||c===s)) h += '<td class="corner"></td>';
                        else h += `<td class="edge ${e===currentProb.start?'light-source':''}">${e||''}</td>`;
                    } else {
                        let m = currentProb.mirrors[`${r},${c}`];
                        let label = `<span class="coord-label">${rows[r]}${cols[c]}</span>`;
                        let mirrorHtml = '';
                        if(m) {
                            const color = m.color === 'red' ? 'var(--red)' : 'var(--blue)';
                            const x1 = m.type === 'f' ? '100' : '0';
                            const y1 = '0';
                            const x2 = m.type === 'f' ? '0' : '100';
                            const y2 = '100';
                            mirrorHtml = `<svg class="mirror-svg" viewBox="0 0 100 100" preserveAspectRatio="none"><line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="mirror-line" stroke="${color}" /></svg>`;
                        }
                        h += `<td>${label}${mirrorHtml}</td>`;
                    }
                }
                h += '</tr>';
            }
            document.getElementById('grid-target').innerHTML = h + '</table>';
        }

        function getEdgeID(r, c, s) {
            if(r===-1 && c>=0 && c<s) return c+1;
            if(c===s && r>=0 && r<s) return s+r+1;
            if(r===s && c>=0 && c<s) return s*2+(s-c);
            if(c===-1 && r>=0 && r<s) return s*3+(s-r);
            return null;
        }

        function updateTimer() {
            let d = Date.now()-startT;
            let ms = String(d%1000).padStart(3,'0').slice(0,2);
            let s = String(Math.floor(d/1000)%60).padStart(2,'0');
            let m = String(Math.floor(d/60000)).padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}.${ms}`;
        }

        function submitRecord() {
            const nick = document.getElementById('nick').value;
            const ans = document.getElementById('ans_input').value;
            const time = document.getElementById('timer').innerText;
            const num = document.getElementById('lv_num').value;

            if(!ans) { alert("ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

            db.ref(`records/p${num}`).push({
                n: nick,
                a: ans,
                t: time,
                ts: firebase.database.ServerValue.TIMESTAMP
            });
            
            alert("ê¸°ë¡ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        function loadRecords(num) {
            // ìµœì‹ ìˆœìœ¼ë¡œ 50ê°œê¹Œì§€ í‘œì‹œ
            db.ref(`records/p${num}`).orderByChild('ts').limitToLast(50).on('value', snap => {
                let h = "<strong>ğŸ“‹ ìµœê·¼ ì œì¶œ ê¸°ë¡ (ì „ì²´)</strong><br>";
                let records = [];
                snap.forEach(c => { records.push(c.val()); });
                records.reverse(); // ìµœì‹ ì´ ìœ„ë¡œ ì˜¤ê²Œ

                records.forEach(r => {
                    h += `<div class="rank-item">${r.n} <b>(${r.a})</b> <i>${r.t}</i></div>`;
                });
                document.getElementById('rank-list').innerHTML = h || "ì•„ì§ ì œì¶œëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
            });
        }
    </script>
</body>
</html>